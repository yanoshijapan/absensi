<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Yanoshi</title>
    <style>
        :root {
            --primary-color: #007BFF; --secondary-color: #6c757d; --background-color: #f4f7f6;
            --surface-color: #ffffff; --text-color: #333; --header-height: 70px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); overflow-x: hidden; }
        .loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .loader-wrapper.show { opacity: 1; visibility: visible; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .popup-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 10000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .popup-wrapper.show { opacity: 1; visibility: visible; }
        .popup-box { background-color: var(--surface-color); padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); text-align: center; transform: scale(0.9); transition: transform 0.3s; max-width: 90%; }
        .popup-box h3 { margin-bottom: 20px; font-size: 1.5em; }
        .popup-box button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        .popup-box button:hover { background-color: #0056b3; }
        header { position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); background-color: var(--surface-color); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); z-index: 1000; }
        .logo { font-size: 1.8em; font-weight: 700; color: var(--primary-color); }
        .hamburger { display: flex; flex-direction: column; justify-content: space-around; width: 2rem; height: 2rem; background: transparent; border: none; cursor: pointer; padding: 0; z-index: 1002; }
        .hamburger span { width: 2rem; height: 0.25rem; background: var(--text-color); border-radius: 10px; transition: all 0.3s linear; position: relative; transform-origin: 1px; }
        .hamburger.open span:nth-child(1) { transform: rotate(45deg); } .hamburger.open span:nth-child(2) { opacity: 0; transform: translateX(20px); } .hamburger.open span:nth-child(3) { transform: rotate(-45deg); }
        .nav-menu { position: fixed; top: 0; right: -100%; width: 80%; max-width: 300px; height: 100vh; background: var(--surface-color); box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); transition: right 0.4s ease-in-out; z-index: 1001; display: flex; flex-direction: column; padding: 20px; padding-top: 60px; }
        .nav-menu.open { right: 0; }
        .nav-menu .menu-section { display: none; flex-direction: column; height: 100%; }
        .nav-menu .menu-section.active { display: flex; }
        .nav-menu .menu-item-button { background: none; border: none; font-family: 'Poppins', sans-serif; font-size: 1.2em; padding: 15px 0; text-align: left; cursor: pointer; width: 100%; border-bottom: 1px solid #eee; }
        .nav-menu .menu-item-button:hover { color: var(--primary-color); }
        .close-menu-btn { position: absolute; top: 15px; right: 20px; background: transparent; border: none; font-size: 2.5rem; color: var(--secondary-color); cursor: pointer; line-height: 1; padding: 0; }
        .close-menu-btn:hover { color: var(--text-color); }
        main { padding-top: var(--header-height); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .view { width: 100%; max-width: 500px; padding: 20px; display: none; flex-direction: column; align-items: center; animation: fadeIn 0.5s; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-container { width: 100%; background: var(--surface-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .form-container h2 { text-align: center; margin-bottom: 25px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .input-group input, .input-group textarea { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; font-family: 'Poppins', sans-serif; transition: border-color 0.3s; }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: var(--primary-color); }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .btn:hover { background-color: #0056b3; } .btn:active { transform: scale(0.98); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #5a6268; }
        .switch-link { text-align: center; margin-top: 20px; }
        .switch-link a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .clock-widget { background: var(--surface-color); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); text-align: center; width: 100%; margin-bottom: 25px; }
        .clock-time { font-size: 3em; font-weight: 700; color: var(--primary-color); }
        .clock-date { font-size: 1.1em; color: var(--secondary-color); }
        .user-profile { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; }
        .user-profile img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 4px solid var(--primary-color); }
        .user-profile .user-name { font-size: 1.5em; font-weight: 600; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-bottom: 15px; }
        .action-buttons .btn { padding: 20px; font-size: 1.2em; }
        .izin-btn { width: 100%; }
        .overlay-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background-color); z-index: 1003; display: none; flex-direction: column; justify-content: center; align-items: center; overflow-y: auto; }
        #camera-view { background: black; }
        #video-preview { width: 100%; height: 100%; object-fit: cover; }
        #camera-overlay { position: absolute; top: 20px; color: white; background-color: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; font-size: 1.1em; }
        #capture-btn, #cancel-camera-btn { position: absolute; bottom: 30px; border: 4px solid white; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; background-color: rgba(255,255,255,0.3); }
        #capture-btn { left: 50%; transform: translateX(-50%); }
        #cancel-camera-btn { left: 30px; width: 50px; height: 50px; font-size: 1.5em; color: white; background: transparent; border: 2px solid white; }
    </style>
</head>
<body>
    <header>
        <div class="logo">Absensi</div>
        <button class="hamburger" id="hamburger-btn"><span></span><span></span><span></span></button>
    </header>
    <nav class="nav-menu" id="nav-menu">
        <button class="close-menu-btn" id="close-menu-btn">&times;</button>
        <div class="menu-section" id="nav-logged-out">
             <h2>Login</h2>
             <div class="input-group"><label for="nav-email">Email</label><input type="email" id="nav-email" placeholder="email@anda.com"></div>
             <div class="input-group"><label for="nav-password">Password</label><input type="password" id="nav-password" placeholder="********"></div>
             <button class="btn" id="nav-login-btn">Login</button>
             <div class="switch-link"><a href="#" onclick="showView('signup-view'); closeMenu();">Sign up disini</a></div>
        </div>
        <div class="menu-section" id="nav-logged-in">
            <button class="menu-item-button" id="open-profile-settings-btn">Atur Profil</button>
            <button class="menu-item-button" id="open-team-list-btn">Team</button>
            <button class="btn btn-secondary" id="logout-btn" style="margin-top: auto;">Logout</button>
        </div>
    </nav>
    <main>
        <div class="view active" id="login-view"><div class="form-container"><h2>Log In Akun</h2><div class="input-group"><label for="login-email">Alamat Email</label><input type="email" id="login-email" required></div><div class="input-group"><label for="login-password">Password</label><input type="password" id="login-password" required></div><button class="btn" id="login-btn">Login</button><div class="switch-link">Belum punya akun? <a href="#" onclick="showView('signup-view')">Sign up disini</a></div></div></div>
        <div class="view" id="signup-view"><div class="form-container"><h2>Daftar Akun Baru</h2><div class="input-group"><label for="signup-name">Nama Lengkap/Username</label><input type="text" id="signup-name" required></div><div class="input-group"><label for="signup-email">Alamat Email</label><input type="email" id="signup-email" required></div><div class="input-group"><label for="signup-wa">Nomor WhatsApp</label><input type="tel" id="signup-wa" required></div><div class="input-group"><label for="signup-password">Password</label><input type="password" id="signup-password" required></div><button class="btn" id="signup-btn">Sign Up</button><div class="switch-link">Sudah punya akun? <a href="#" onclick="showView('login-view')">Login disini</a></div></div></div>
        <div class="view" id="main-app-view"><div class="clock-widget"><div class="clock-time" id="clock-time">00:00:00</div><div class="clock-date" id="clock-date">Tanggal</div></div><div class="user-profile"><img src="https://i.ibb.co/606BFx1/user-placeholder.png" alt="Foto Profil" id="user-photo"><span class="user-name" id="user-name">Nama Pengguna</span></div><div class="action-buttons"><button class="btn" id="absen-masuk-btn">Absen Masuk</button><button class="btn btn-secondary" id="absen-keluar-btn">Absen Keluar</button></div><button class="btn izin-btn" id="izin-btn">Ajukan Izin</button></div>
        <div class="view" id="izin-view"><div class="form-container"><h2>Formulir Pengajuan Izin</h2><div class="input-group"><label for="alasan-izin">Alasan Izin</label><textarea id="alasan-izin" rows="5"></textarea></div><button class="btn" id="submit-izin-btn">Ajukan Izin</button><button class="btn btn-secondary" style="margin-top: 10px;" onclick="showView('main-app-view')">Batal</button></div></div>
    </main>

    <div class="overlay-view" id="profile-settings-view"><div class="form-container" style="max-width: 500px; width: 90%;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2 style="margin: 0;">Atur Profil</h2><button id="close-profile-settings-btn" style="background: none; border: none; font-size: 2rem; cursor: pointer;">&times;</button></div><div class="profile-photo-section" style="text-align: center; margin-bottom: 20px;"><img src="https://i.postimg.cc/SNkBCtS3/user-placeholder.png" id="menu-user-photo" alt="Foto Profil" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 3px solid var(--primary-color);"><input type="file" id="photo-uploader" accept="image/*" style="display: none;"><button class="btn btn-secondary" id="change-photo-btn" style="width: auto; padding: 8px 15px; font-size: 0.9em;">Ubah Foto</button></div><div class="input-group"><label for="username-input">Set Username</label><input type="text" id="username-input" placeholder="Masukkan username baru"></div><button class="btn" id="save-username-btn" style="width: auto; padding: 10px 15px; font-size: 1em; margin-bottom: 20px;">Simpan Username</button><div class="input-group"><label for="whatsapp-input">Update Nomor WhatsApp</label><input type="tel" id="whatsapp-input" placeholder="08xxxxxxxxxx"></div><button class="btn" id="save-whatsapp-btn" style="width: auto; padding: 10px 15px; font-size: 1em; margin-bottom: 20px;">Simpan Nomor</button><div class="input-group"><label for="new-password">Ubah Password</label><input type="password" id="new-password" placeholder="Password baru"></div><button class="btn" id="change-password-btn" style="width: auto; padding: 10px 15px;">Simpan Password</button></div></div>
    <div class="overlay-view" id="team-list-view"><div class="form-container" style="max-width: 500px; width: 90%;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2 style="margin: 0;">Daftar Tim</h2><button id="close-team-list-btn" style="background: none; border: none; font-size: 2rem; cursor: pointer;">&times;</button></div><div id="team-list-container" style="max-height: 70vh; overflow-y: auto;"></div></div></div>
    <div class="overlay-view" id="camera-view"><div id="camera-overlay">Posisikan wajah Anda</div><video id="video-preview" autoplay playsinline></video><canvas id="canvas" style="display:none;"></canvas><button id="capture-btn"></button><button id="cancel-camera-btn">X</button></div>
    
    <div class="loader-wrapper" id="loader"><div class="loader"></div></div>
    <div class="popup-wrapper" id="popup"><div class="popup-box"><h3 id="popup-message">Aksi Berhasil</h3><button id="close-popup-btn">Tutup</button><button id="retry-btn" class="btn-secondary" style="margin-left: 10px; display: none;">Coba Lagi</button></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAL44qnUYBXRb4dONGlvV5LUFvA73z8gVk",
          authDomain: "absensiyanoshi.firebaseapp.com",
          projectId: "absensiyanoshi",
          storageBucket: "absensiyanoshi.firebasestorage.app",
          messagingSenderId: "1015425488771",
          appId: "1:1015425488771:web:4d55ea4a32387286d808b6",
          measurementId: "G-E1LVDFKVGV"
        };
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbycvTinrmBhh2iQJPcOnkemfT_YzxkWjMUXTFCQOtAcaD6SmObvsvUbvioC2PKy4Z-iYQ/exec';
        const CLOUDINARY_CLOUD_NAME = 'dhsbixafr';
        const CLOUDINARY_UPLOAD_PRESET = 'yanoshi_profile_photo';
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const allViews = document.querySelectorAll('.view, .overlay-view');
        const loader = document.getElementById('loader');
        let currentUser = null, currentUserData = null, teamData = null, clockInterval, lastFailedRequest = null;

        function showView(viewId) { 
            allViews.forEach(view => {
                view.classList.remove('active');
                if (view.classList.contains('overlay-view')) view.style.display = 'none';
            });
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
                if (targetView.classList.contains('overlay-view')) targetView.style.display = 'flex';
            }
        }
        function showLoader() { loader.classList.add('show'); }
        function hideLoader() { loader.classList.remove('show'); }
        function showPopup(message, isError = false) {
            document.getElementById('popup-message').textContent = message;
            const retryBtn = document.getElementById('retry-btn');
            retryBtn.style.display = isError ? 'inline-block' : 'none';
            document.getElementById('popup').classList.add('show');
        }
        document.getElementById('close-popup-btn').addEventListener('click', () => { document.getElementById('popup').classList.remove('show'); });
        document.getElementById('retry-btn').addEventListener('click', () => {
            if (lastFailedRequest) { document.getElementById('popup').classList.remove('show'); handleFetch(lastFailedRequest.url, lastFailedRequest.options, lastFailedRequest.successMessage); }
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                fetchInitialData(user.uid).then(() => {
                    document.getElementById('nav-logged-out').classList.remove('active');
                    document.getElementById('nav-logged-in').classList.add('active');
                    showView('main-app-view'); startClock();
                });
            } else {
                currentUser = null; currentUserData = null; teamData = null;
                document.getElementById('nav-logged-in').classList.remove('active');
                document.getElementById('nav-logged-out').classList.add('active');
                showView('login-view'); stopClock();
            }
        });
        
        async function fetchInitialData(uid) {
            showLoader();
            try {
                const userDocRef = db.collection('users').doc(uid);
                const userDoc = await userDocRef.get();
                if (!userDoc.exists) {
                    const basicUserData = { uid: currentUser.uid, email: currentUser.email, name: currentUser.email.split('@')[0], whatsapp: '' };
                    await userDocRef.set(basicUserData);
                    currentUserData = basicUserData;
                } else { currentUserData = userDoc.data(); }
                const teamSnapshot = await db.collection('users').orderBy('name').get();
                teamData = []; teamSnapshot.forEach(doc => { teamData.push(doc.data()); });
                updateUserProfileUI();
            } catch (error) { console.error("Error fetching initial data:", error); alert("Gagal memuat data awal.");
            } finally { hideLoader(); }
        }
        
        function updateUserProfileUI() {
            const mainPhoto = document.getElementById('user-photo'), menuPhoto = document.getElementById('menu-user-photo'), placeholder = 'https://i.postimg.cc/SNkBCtS3/user-placeholder.png';
            if (currentUserData && currentUserData.name) { document.getElementById('user-name').textContent = currentUserData.name; } 
            else if (currentUser) { document.getElementById('user-name').textContent = currentUser.email; }
            const photoUrl = currentUserData && currentUserData.profilePhotoURL ? currentUserData.profilePhotoURL : placeholder;
            mainPhoto.src = photoUrl; menuPhoto.src = photoUrl;
        }

        document.getElementById('signup-btn').addEventListener('click', () => {
            const name = document.getElementById('signup-name').value, email = document.getElementById('signup-email').value, password = document.getElementById('signup-password').value, whatsapp = document.getElementById('signup-wa').value;
            if (!name || !email || !password || !whatsapp) { return alert("Harap isi semua kolom."); }
            showLoader();
            auth.createUserWithEmailAndPassword(email, password).then(cred => {
                return db.collection('users').doc(cred.user.uid).set({ uid: cred.user.uid, name, email, whatsapp });
            }).then(() => { hideLoader(); showPopup('Pendaftaran berhasil! Silakan login.'); showView('login-view');
            }).catch(error => { hideLoader(); alert(error.message); });
        });

        const handleLogin = () => {
            const email = document.getElementById('login-email').value || document.getElementById('nav-email').value, password = document.getElementById('login-password').value || document.getElementById('nav-password').value;
            if (!email || !password) return alert("Email dan password harus diisi.");
            showLoader();
            auth.signInWithEmailAndPassword(email, password).then(() => closeMenu()).catch(error => { hideLoader(); alert(error.message); });
        };
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('nav-login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); closeMenu(); });

        document.getElementById('save-username-btn').addEventListener('click', async () => {
            const newUsername = document.getElementById('username-input').value;
            if (!newUsername || newUsername.length < 3) return alert("Username minimal harus 3 karakter.");
            if (!currentUser) return;
            showLoader();
            try {
                await db.collection('users').doc(currentUser.uid).update({ name: newUsername });
                if (currentUserData) currentUserData.name = newUsername;
                updateUserProfileUI();
                hideLoader(); showPopup("Username berhasil diperbarui!");
            } catch (error) { hideLoader(); console.error("Error updating username:", error); alert("Gagal memperbarui username: " + error.message); }
        });
        
        document.getElementById('save-whatsapp-btn').addEventListener('click', async () => {
            const newWhatsapp = document.getElementById('whatsapp-input').value;
            if (!newWhatsapp || newWhatsapp.length < 9) return alert("Nomor WhatsApp tidak valid.");
            if (!currentUser) return;
            showLoader();
            try {
                await db.collection('users').doc(currentUser.uid).update({ whatsapp: newWhatsapp });
                if (currentUserData) currentUserData.whatsapp = newWhatsapp;
                const userInTeamList = teamData.find(member => member.uid === currentUser.uid);
                if (userInTeamList) userInTeamList.whatsapp = newWhatsapp;
                hideLoader(); showPopup("Nomor WhatsApp berhasil diperbarui!");
            } catch (error) { hideLoader(); console.error("Error updating WhatsApp:", error); alert("Gagal memperbarui nomor: " + error.message); }
        });

        document.getElementById('change-password-btn').addEventListener('click', () => {
            const newPassword = document.getElementById('new-password').value;
            if (newPassword.length < 6) return alert("Password baru harus minimal 6 karakter.");
            showLoader();
            auth.currentUser.updatePassword(newPassword).then(() => {
                hideLoader(); document.getElementById('new-password').value = ''; alert("Password berhasil diubah!");
            }).catch((error) => {
                hideLoader(); alert("Gagal mengubah password: " + error.message);
                if (error.code === 'auth/requires-recent-login') alert("Sesi Anda sudah terlalu lama. Harap logout dan login kembali untuk mengubah password.");
            });
        });

        document.getElementById('change-photo-btn').addEventListener('click', () => { document.getElementById('photo-uploader').click(); });
        document.getElementById('photo-uploader').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) uploadProfilePhoto(file); else if(file) alert('Harap pilih file gambar.');
        });
        
        function displayTeam() {
            const container = document.getElementById('team-list-container');
            if (!teamData || teamData.length === 0) { container.innerHTML = '<em>Belum ada anggota tim.</em>'; return; }
            container.innerHTML = teamData.map(member => `
                <div style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em;">
                    <strong>${member.name || member.email.split('@')[0]}</strong><br>
                    <small style="color: #666;">${member.email}</small><br>
                    <small style="color: #666;">WA: ${member.whatsapp || '-'}</small>
                </div>
            `).join('');
        }
        function startClock() {
            const timeEl = document.getElementById('clock-time'), dateEl = document.getElementById('clock-date');
            const updateClock = () => { const now = new Date(); timeEl.textContent = now.toLocaleTimeString('id-ID'); dateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); };
            updateClock(); clockInterval = setInterval(updateClock, 1000);
        }
        function stopClock() { clearInterval(clockInterval); }

        document.getElementById('izin-btn').addEventListener('click', () => showView('izin-view'));
        document.getElementById('submit-izin-btn').addEventListener('click', () => {
            const reason = document.getElementById('alasan-izin').value;
            if (!reason) return alert('Alasan izin tidak boleh kosong!');
            submitDataToGAS({ email: currentUser.email, name: (currentUserData && currentUserData.name) || currentUser.email.split('@')[0], type: 'izin', reason }, "Izin berhasil diajukan");
        });

        const video = document.getElementById('video-preview'), canvas = document.getElementById('canvas');
        let stream, currentAbsenType;
        async function startCamera(absenType) {
            currentAbsenType = absenType;
            try { stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false }); video.srcObject = stream; showView('camera-view');
            } catch (err) { console.error("Error accessing camera: ", err); alert('Tidak bisa mengakses kamera.'); }
        }
        function stopCamera() { if (stream) stream.getTracks().forEach(track => track.stop()); showView('main-app-view'); }
        document.getElementById('absen-masuk-btn').addEventListener('click', () => startCamera('masuk'));
        document.getElementById('absen-keluar-btn').addEventListener('click', () => startCamera('keluar'));
        document.getElementById('cancel-camera-btn').addEventListener('click', stopCamera);
        document.getElementById('capture-btn').addEventListener('click', () => {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const photoData = canvas.toDataURL('image/jpeg'); stopCamera();
            submitDataToGAS({ email: currentUser.email, name: (currentUserData && currentUserData.name) || currentUser.email.split('@')[0], type: currentAbsenType, photoData }, "Absen berhasil!");
        });
        
        async function handleFetch(url, options, successMessage) {
            showLoader();
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`Server merespon dengan status: ${response.status}`);
                const result = await response.json();
                if (result.error) throw new Error(result.error.message);
                hideLoader();
                showPopup(successMessage);
                lastFailedRequest = null;
                return result;
            } catch (error) {
                hideLoader();
                console.error('Fetch Error:', error);
                lastFailedRequest = { url, options, successMessage };
                showPopup(`Gagal: ${error.message}. Cek koneksi Anda.`, true);
            }
        }
        function submitDataToGAS(data, successMessage) {
            handleFetch(GAS_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }, successMessage);
        }
        async function uploadProfilePhoto(file) {
            if (!currentUser) return;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const result = await handleFetch(CLOUDINARY_URL, { method: 'POST', body: formData }, 'Foto profil berhasil diperbarui!');
            if (result && result.secure_url) {
                const photoURL = result.secure_url;
                await db.collection('users').doc(currentUser.uid).set({ profilePhotoURL: photoURL }, { merge: true });
                if(currentUserData) currentUserData.profilePhotoURL = photoURL;
                updateUserProfileUI();
            }
        }
        const hamburgerBtn = document.getElementById('hamburger-btn'), navMenu = document.getElementById('nav-menu'), closeMenuBtn = document.getElementById('close-menu-btn');
        function closeMenu() { hamburgerBtn.classList.remove('open'); navMenu.classList.remove('open'); }
        hamburgerBtn.addEventListener('click', () => { hamburgerBtn.classList.toggle('open'); navMenu.classList.toggle('open'); });
        closeMenuBtn.addEventListener('click', closeMenu);
        document.addEventListener('click', function(event) {
            if (!navMenu.classList.contains('open')) return;
            const isClickInsideMenu = navMenu.contains(event.target), isClickOnHamburger = hamburgerBtn.contains(event.target);
            if (!isClickInsideMenu && !isClickOnHamburger) closeMenu();
        });
        document.getElementById('open-profile-settings-btn').addEventListener('click', () => {
            if (currentUserData) {
                document.getElementById('username-input').value = currentUserData.name || '';
                document.getElementById('whatsapp-input').value = currentUserData.whatsapp || '';
            }
            showView('profile-settings-view');
            closeMenu();
        });
        document.getElementById('open-team-list-btn').addEventListener('click', () => {
            displayTeam();
            showView('team-list-view');
            closeMenu();
        });
        document.getElementById('close-profile-settings-btn').addEventListener('click', () => showView('main-app-view'));
        document.getElementById('close-team-list-btn').addEventListener('click', () => showView('main-app-view'));
    </script>
</body>
</html>
